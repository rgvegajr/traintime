<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="UTF-8">
    <title>Trains</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>

<body>
    <div class="container">
        <br>
        <!-- Jumbotron -->
        <div class="jumbotron" style="background-color: black; color: white">
            <h1 class="text-center">Anytime is Train Time</h1>
            <p id="currTimeDisplay" style="color: white"></p>
        </div>
        <table class="table" style="border: 1px solid black; border-style: inset ">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">Train Name</th>
                    <th scope="col">Destination</th>
                    <th scope="col">Frequency (minutes)</th>
                    <th scope="col">Next Arrival</th>
                    <th scope="col">Minutes Aways</th>

                </tr>
            </thead>
            <tbody id="new-train">
                <tr id="new-train"></tr>

            </tbody>
        </table>
        <form style="border: 1px solid black; padding: 4px ">
            <div class="form-header" style="background-color: black; color: white">
                <h5 style="padding: 2px">Add Train</h5>
            </div>
            <div class="form-group">
                <label for="name-input">Train Name</label>
                <input class="form-control" id="name-input" type="text">
            </div>
            <div class="form-group">
                <label for="dest-input">Destination</label>
                <input class="form-control" id="dest-input" type="text">
            </div>
            <div class="form-group">
                <label for="firstTrainTime-input">First Train Time (HH:mm - 24 hour time)</label>
                <input class="form-control" id="firstTrainTime-input" name="time" type="time" />
            </div>
            <div class="form-group">
                <label for="freq-input">Frequency (min)</label>
                <input class="form-control" id="freq-input" type="number">
            </div>
            <button class="btn btn-primary" id="add-train" type="submit">Submit</button>
        </form>

    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>

    <!-- Boostrap required libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <!-- Firebase References -->
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-database.js"></script>

    <!-- Moment.js Reference -->
    <script src="https://momentjs.com/downloads/moment.min.js"></script>

    <!-- Script -->
    <script>
        // $(document).ready(function() {
        // Initialize Firebase
        let firebaseConfig = {
            apiKey: "AIzaSyDwNylk7AZd_2kvyFflaLnseJN0flTZ1_8",
            authDomain: "firstproj-b65e0.firebaseapp.com",
            databaseURL: "https://firstproj-b65e0.firebaseio.com",
            projectId: "firstproj-b65e0",
            storageBucket: "firstproj-b65e0.appspot.com",
            messagingSenderId: "1039411906706",
            appId: "1:1039411906706:web:018b0e35bf9f42cc307e4b"
        };

        firebase.initializeApp(firebaseConfig);

        // Create a variable to reference the database function
        let database = firebase.database();

        let name = "";
        let dest = "";
        let firstTrainTime = "";
        let freq = "";
        let nextTrain = "";
        let nextTrainTime = "";
        let minUntilNext = "";
        let tRemainder = "";
        let currTime = moment().format("X");
        let diff = "";
        // let arrTimeArray = [];
        $("#currTimeDisplay").text("Current time is: " + moment(currTime).format("HH:mm"));

        // Capture Button Click to add a train to the database and table
        $("#add-train").on("click", function(event) {
            // Don't refresh the page!
            event.preventDefault();

            name = $("#name-input").val().trim();
            dest = $("#dest-input").val().trim();
            firstTrainTime = moment($("#firstTrainTime-input").val().trim(), "HH:mm").format("X");
            freq = $("#freq-input").val().trim();

            console.log(currTime);
            console.log(name);
            console.log(dest);
            console.log(firstTrainTime);
            console.log(freq);

            //insert code to generate train schedule from inputs ..database is a function defined above as firebase.database()
            if (firstTrainTime <= currTime) {
                diff = Math.round((currTime - firstTrainTime) / 60);
                console.log("diff in min=" + diff);
                tRemainder = diff % freq;
                minUntilNext = freq - tRemainder;
                console.log("if loop minUntilNext=" + minUntilNext);
                nextTrain = moment().add(minUntilNext, "minutes");
                nextTrainTime = moment(nextTrain).format("HH:mm");
            } else {
                minUntilNext = Math.round((firstTrainTime - currTime) / 60);
                console.log("else loop minUntilNext=" + minUntilNext);
                nextTrain = moment().add(minUntilNext, "minutes");
                nextTrainTime = moment(nextTrain).format("HH:mm");
            };

            console.log("Next train: " + nextTrainTime);

            database.ref().push({
                name: name,
                dest: dest,
                firstTrainTime: firstTrainTime,
                freq: freq,
                nextTrainTime: nextTrainTime,
                minUntilNext: minUntilNext,
                dateAdded: firebase.database.ServerValue.TIMESTAMP
            });

            alert("Train added!");

        });

        database.ref().on("child_added", function(childSnapshot) {
            console.log(childSnapshot.val());

            let newTrain = $("<tr>").append(
                $("<td>").text(childSnapshot.val().name),
                $("<td>").text(childSnapshot.val().dest),
                $("<td>").text(childSnapshot.val().freq),
                $("<td>").text(childSnapshot.val().nextTrainTime),
                $("<td>").text(childSnapshot.val().minUntilNext)
            );
            $("#new-train").append(newTrain);
        }, function(errorObject) {
            console.log("Errors handled: " + errorObject.code);
        });





        //moment().endOf('day').fromNow();          // in 13 hours
        //moment().startOf('hour').fromNow();       // 6 minutes ago

        //});
    </script>
</body>

</html>